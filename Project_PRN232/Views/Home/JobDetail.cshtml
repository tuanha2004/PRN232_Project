@model Project_PRN232.Models.DTOs.JobDto
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@{
    ViewData["Title"] = Model.Title ?? "Chi tiết công việc";
    var isLoggedIn = !string.IsNullOrEmpty(HttpContextAccessor.HttpContext?.Session.GetString("JwtToken"));
    var userRole = HttpContextAccessor.HttpContext?.Session.GetString("UserRole");
    var fullName = HttpContextAccessor.HttpContext?.Session.GetString("FullName");
    var userPhone = HttpContextAccessor.HttpContext?.Session.GetString("UserPhone");
    var canApply = isLoggedIn && (userRole == "Student" || userRole == "Admin");
}

<div class="container my-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index"><i class="fas fa-home me-1"></i>Trang chủ</a></li>
            <li class="breadcrumb-item active" aria-current="page">Chi tiết công việc</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-primary text-white py-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="mb-2">
                                <i class="fas fa-briefcase me-2"></i>@Model.Title
                            </h2>
                            @if (!string.IsNullOrEmpty(Model.ProviderName))
                            {
                                <p class="mb-0">
                                    <i class="fas fa-building me-2"></i>@Model.ProviderName
                                </p>
                            }
                        </div>
                        @if (Model.Status == "Open")
                        {
                            <span class="badge bg-success fs-6 px-3 py-2">
                                <i class="fas fa-door-open me-1"></i>Đang tuyển
                            </span>
                        }
                        else if (Model.Status == "Closed")
                        {
                            <span class="badge bg-danger fs-6 px-3 py-2">
                                <i class="fas fa-door-closed me-1"></i>Đã đóng
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-secondary fs-6 px-3 py-2">
                                <i class="fas fa-times-circle me-1"></i>@Model.Status
                            </span>
                        }
                    </div>
                </div>

                <div class="card-body p-4">
                    <!-- Job Info Grid -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <div class="bg-danger text-white rounded-circle p-3 me-3">
                                    <i class="fas fa-map-marker-alt fa-lg"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Địa điểm</small>
                                    <strong>@(Model.Location ?? "Chưa cập nhật")</strong>
                                </div>
                            </div>
                        </div>

                        @if (Model.Salary.HasValue)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success text-white rounded-circle p-3 me-3">
                                        <i class="fas fa-dollar-sign fa-lg"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Mức lương</small>
                                        <strong class="text-success">@Model.Salary.Value.ToString("N0") VNĐ/h</strong>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (Model.StartDate.HasValue)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-info text-white rounded-circle p-3 me-3">
                                        <i class="fas fa-calendar-check fa-lg"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Ngày bắt đầu</small>
                                        <strong>@Model.StartDate.Value.ToString("dd/MM/yyyy")</strong>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (Model.EndDate.HasValue)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning text-dark rounded-circle p-3 me-3">
                                        <i class="fas fa-calendar-times fa-lg"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Ngày kết thúc</small>
                                        <strong>@Model.EndDate.Value.ToString("dd/MM/yyyy")</strong>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <hr class="my-4">

                    <!-- Description -->
                    <div class="mb-4">
                        <h4 class="mb-3">
                            <i class="fas fa-align-left me-2 text-primary"></i>Mô tả công việc
                        </h4>
                        <div class="bg-light p-4 rounded">
                            @if (!string.IsNullOrEmpty(Model.Description))
                            {
                                <p class="mb-0" style="white-space: pre-line;">@Model.Description</p>
                            }
                            else
                            {
                                <p class="text-muted mb-0">Chưa có mô tả chi tiết.</p>
                            }
                        </div>
                    </div>

                    <!-- Application Form -->
                    @if (Model.Status == "Open")
                    {
                        <!-- Check-in Section for Approved Students -->
                        @if (canApply && ViewBag.IsApproved == true)
                        {
                            <div class="card border-primary mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h4 class="mb-0">
                                        <i class="fas fa-clock me-2"></i>Check-in / Check-out
                                    </h4>
                                </div>
                                <div class="card-body">
                                    @if (ViewBag.IsCheckedIn == true)
                                    {
                                        <div class="alert alert-success mb-3">
                                            <i class="fas fa-user-check me-2"></i>
                                            <strong>Bạn đã check-in cho công việc này!</strong>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <a asp-controller="Checkin" asp-action="Index" class="btn btn-primary btn-lg">
                                                <i class="fas fa-history me-2"></i>Xem chi tiết & Check-out
                                            </a>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-info mb-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Bạn đã được duyệt cho công việc này!</strong><br/>
                                            Check-in khi bạn bắt đầu làm việc để ghi nhận thời gian.
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-success btn-lg" 
                                                    data-job-id="@Model.JobId" 
                                                    onclick="checkin(this.getAttribute('data-job-id'))">
                                                <i class="fas fa-sign-in-alt me-2"></i>Check-in ngay
                                            </button>
                                            <a asp-controller="Checkin" asp-action="Index" class="btn btn-outline-secondary">
                                                <i class="fas fa-history me-2"></i>Xem lịch sử check-in
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (canApply)
                        {
                            <div class="card border-success mb-4">
                                <div class="card-header bg-success text-white">
                                    <h4 class="mb-0">
                                        <i class="fas fa-file-alt me-2"></i>Đơn ứng tuyển
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <form id="applicationForm">
                                        <input type="hidden" id="jobId" value="@Model.JobId" />
                                        
                                        <div class="mb-3">
                                            <label for="fullName" class="form-label fw-bold">
                                                <i class="fas fa-user me-2"></i>Họ và tên <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control form-control-lg" id="fullName" 
                                                   value="@fullName" placeholder="Nhập họ và tên của bạn" required>
                                            <small class="text-muted">Tên của bạn sẽ được gửi kèm đơn ứng tuyển</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="phone" class="form-label fw-bold">
                                                <i class="fas fa-phone me-2"></i>Số điện thoại <span class="text-danger">*</span>
                                            </label>
                                            <input type="tel" class="form-control form-control-lg" id="phone" 
                                                   value="@userPhone" placeholder="0123456789" required>
                                            <small class="text-muted">Nhà tuyển dụng sẽ liên hệ qua số này</small>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="studentYear" class="form-label fw-bold">
                                                    <i class="fas fa-graduation-cap me-2"></i>Sinh viên năm <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select form-select-lg" id="studentYear" required>
                                                    <option value="Year 1" selected>Năm 1</option>
                                                    <option value="Year 2">Năm 2</option>
                                                    <option value="Year 3">Năm 3</option>
                                                    <option value="Year 4">Năm 4</option>
                                                </select>
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label for="workType" class="form-label fw-bold">
                                                    <i class="fas fa-briefcase me-2"></i>Loại công việc <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select form-select-lg" id="workType" required>
                                                    <option value="Part-time" selected>Part-time</option>
                                                    <option value="Full-time">Full-time</option>
                                                    <option value="Internship">Thực tập</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="notes" class="form-label fw-bold">
                                                <i class="fas fa-comment-alt me-2"></i>Ghi chú / Kinh nghiệm
                                            </label>
                                            <textarea class="form-control" id="notes" rows="4" 
                                                      placeholder="Viết về kinh nghiệm, kỹ năng của bạn phù hợp với công việc này..."></textarea>
                                            <small class="text-muted">Tùy chọn - Giúp nhà tuyển dụng hiểu rõ hơn về bạn</small>
                                        </div>

                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Đảm bảo thông tin chính xác. Nhà tuyển dụng sẽ liên hệ với bạn trong vòng 24-48 giờ.
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-success btn-lg">
                                                <i class="fas fa-paper-plane me-2"></i>Gửi đơn ứng tuyển
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        }
                        else if (isLoggedIn && userRole == "Provider")
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Chỉ sinh viên mới có thể ứng tuyển.</strong><br/>
                                Tài khoản của bạn là nhà tuyển dụng. Vui lòng đăng nhập bằng tài khoản sinh viên để ứng tuyển.
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Bạn cần <a asp-controller="Account" asp-action="Login" class="alert-link fw-bold">đăng nhập</a> 
                                <strong>bằng tài khoản sinh viên</strong> để ứng tuyển công việc này.
                            </div>
                        }
                    }
                    else if (Model.Status == "Closed")
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-lock me-2"></i>
                            Công việc này đã đóng và không còn nhận ứng tuyển.
                            @if (Model.EndDate.HasValue && Model.EndDate.Value < DateOnly.FromDateTime(DateTime.Today))
                            {
                                <br/><small class="text-muted">Lý do: Đã quá hạn (@Model.EndDate.Value.ToString("dd/MM/yyyy"))</small>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-secondary">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Công việc này hiện không khả dụng.
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Company Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-building me-2"></i>Thông tin nhà tuyển dụng
                    </h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.ProviderName))
                    {
                        <div class="mb-3">
                            <small class="text-muted d-block">Tên công ty</small>
                            <strong>@Model.ProviderName</strong>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.ProviderEmail))
                    {
                        <div class="mb-3">
                            <small class="text-muted d-block">Email liên hệ</small>
                            <a href="mailto:@Model.ProviderEmail" class="text-decoration-none">
                                <i class="fas fa-envelope me-1"></i>@Model.ProviderEmail
                            </a>
                        </div>
                    }
                </div>
            </div>

            <!-- Share -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-share-alt me-2"></i>Chia sẻ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="shareJob()">
                            <i class="fas fa-share me-2"></i>Chia sẻ công việc này
                        </button>
                    </div>
                </div>
            </div>

            <!-- Back Button -->
            <div class="d-grid">
                <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Check-in function
        function checkin(jobId) {
            const jobIdInt = parseInt(jobId);

            if (!jobIdInt || jobIdInt <= 0) {
                alert('Có lỗi xảy ra. Vui lòng thử lại.');
                return;
            }

            if (!confirm('Bạn có chắc chắn muốn check-in cho công việc này?')) {
                return;
            }

            fetch('/Checkin/Checkin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ jobId: jobIdInt })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message || 'Check-in thất bại');
                }
            })
            .catch(error => {
                alert('Có lỗi xảy ra khi check-in');
            });
        }

        function shareJob() {
            if (navigator.share) {
                navigator.share({
                    title: '@Model.Title',
                    text: 'Xem công việc: @Model.Title',
                    url: window.location.href
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: Copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Đã copy link vào clipboard!');
                });
            }
        }

        // Handle application form submission
        document.getElementById('applicationForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const jobId = document.getElementById('jobId').value;
            const phone = document.getElementById('phone').value;
            const studentYear = document.getElementById('studentYear').value;
            const workType = document.getElementById('workType').value;
            const notes = document.getElementById('notes').value;

            // Validation
            if (!phone || !studentYear || !workType) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc!');
                return;
            }

            // Disable submit button
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang gửi...';

            try {
                const response = await fetch('/Home/ApplyJob', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jobId: parseInt(jobId),
                        phone: phone,
                        studentYear: studentYear,
                        workType: workType,
                        notes: notes
                    })
                });

                // Kiểm tra content type của response
                const contentType = response.headers.get('content-type');
                console.log('Response status:', response.status);
                console.log('Content-Type:', contentType);

                // Nếu response không phải JSON
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Response is not JSON:', text.substring(0, 200));
                    
                    if (response.status === 403) {
                        throw new Error('Bạn không có quyền ứng tuyển. Vui lòng đăng nhập bằng tài khoản sinh viên.');
                    }
                    
                    throw new Error('Server trả về định dạng không hợp lệ. Có thể phiên đăng nhập đã hết hạn.');
                }

                const result = await response.json();
                console.log('Result:', result);

                if (result.success) {
                    alert('✅ ' + result.message);
                    // Reset form
                    this.reset();
                } else {
                    alert('❌ ' + result.message);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi gửi đơn. Vui lòng thử lại sau!');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Phone number validation
        document.getElementById('phone')?.addEventListener('input', function(e) {
            // Remove non-numeric characters
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // Limit to 10-11 digits
            if (this.value.length > 11) {
                this.value = this.value.slice(0, 11);
            }
        });
    </script>
}
